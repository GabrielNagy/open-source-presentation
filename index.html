<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Open Source: User, Maintainer, Contributor</title>
<meta name="author" content="Gabriel Nagy"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="./reveal.js/css/reveal.css"/>

<link rel="stylesheet" href="./reveal.js/css/theme/blood.css" id="theme"/>

<link rel="stylesheet" href="./data/index.css"/>

<!-- If the query includes 'print-pdf', include the PDF print sheet -->
<script>
    if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = './reveal.js/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    }
</script>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide">
<h1 class="title">Open Source: User, Maintainer, Contributor</h1><h2 class="author">Gabriel Nagy</h2><h2 class="date">2019-11-28 Thu 00:00</h2><p class="date">Created: 2019-11-25 Mon 20:35</p>
</section>

<section>
<section id="slide-org0306917">
<h2 id="org0306917">Open Source at Puppet</h2>
<p>
Gabriel Nagy
</p>

</section>
</section>
<section>
<section id="slide-org2f417d1">
<h2 id="org2f417d1"><code>$ whoami</code></h2>
<ul>
<li>Linux &amp; FOSS user</li>
<li>at Puppet since May</li>
<li>working on awesome open-source projects</li>

</ul>

</section>
</section>
<section>
<section id="slide-org31b773e">
<h2 id="org31b773e">what is this?</h2>
<ul>
<li>overview of our projects</li>
<li>how we benefit from using, and being open source ourselves</li>
<li>why is open-source beneficial</li>

</ul>

</section>
</section>
<section>
<section id="slide-org0d3346a">
<h2 id="org0d3346a">puppet-agent</h2>
<ul>
<li>collection of software required for <code>puppet</code> and its dependencies to run</li>
<li>bundles the following:
<ul>
<li><code>runtime</code> - we build our own <code>ruby</code>, <code>curl</code>, <code>openssl</code>, <code>boost</code>, etc.</li>
<li><code>puppet</code> - Ruby gem, our main project</li>
<li><code>facter</code> - Ruby gem (v2), and C++ binary and libraries (v3)</li>
<li><code>...</code> - a bunch of other dependencies (Ruby, C++)</li>

</ul></li>
<li>built, tested, and shipped for <b>45 OSes/platforms</b> (as of November)</li>

</ul>

</section>
</section>
<section>
<section id="slide-orgf5e5ad4">
<h3 id="orgf5e5ad4"><code>puppet</code></h3>
<ul>
<li>configuration management tool, declarative language</li>

</ul>

<pre class="example">
$ puppet resource user gabi
</pre>

<div class="org-src-container">

<pre  class="src src-puppet">user { 'gabi':
  ensure  =&gt; 'present',
  comment =&gt; 'gabi',
  gid     =&gt; 1000,
  groups  =&gt; ['wheel', 'input', 'lp', 'sys', 'network', 'docker'],
  home    =&gt; '/home/gabi',
  shell   =&gt; '/bin/zsh',
  uid     =&gt; 1000,
}
</pre>
</div>

</section>
</section>
<section>
<section id="slide-orge7e2903">
<h3 id="orge7e2903"><code>facter</code></h3>
<ul>
<li>provides facts about the system (network, disks, memory, OS)</li>
<li>current version in C++, can be extended with custom Ruby facts</li>
<li>can be used through a shared library, or standalone by calling its executable</li>

</ul>

<pre class="example">
$ facter system_uptime --json
</pre>

<div class="org-src-container">

<pre  class="src src-js">{
  <span style="font-style: italic;">"system_uptime"</span>: {
    <span style="font-style: italic;">"days"</span>: 0,
    <span style="font-style: italic;">"hours"</span>: 1,
    <span style="font-style: italic;">"seconds"</span>: 4322,
    <span style="font-style: italic;">"uptime"</span>: <span style="font-style: italic;">"1:12 hours"</span>
  }
}
</pre>
</div>

</section>
</section>
<section>
<section id="slide-orgff5a685">
<h2 id="orgff5a685">how we use open source</h2>
<ul>
<li class="fragment appear">keep our runtime up-to-date by patching CVEs</li>
<li class="fragment appear">October vulnerabilities:
<ul>
<li>Ruby</li>
<li>OpenSSL</li>
<li>cURL</li>

</ul></li>
<li class="fragment appear">all upgrades were problematic</li>

</ul>

</section>
</section>
<section>
<section id="slide-org47427b3">
<h3 id="org47427b3"><code>ruby</code></h3>
<ul>
<li>CVE release was a no-op</li>
<li>the version we had to upgrade to was 2.4.8</li>

</ul>
<img class="stretch" src="img/ruby-release.png">
<ul>
<li>2.4.9 was released a couple of minutes before we checked <a href="https://www.ruby-lang.org/">ruby-lang.org</a></li>

</ul>

</section>
</section>
<section>
<section id="slide-org8df1597">
<h3 id="org8df1597"><code>openssl</code></h3>
<ul>
<li>new version did not compile on Windows</li>

</ul>
<img class="stretch" src="img/openssl-release.png">
<ul>
<li>the openssl release prep commit itself did not pass CI</li>
<li>issue was fixed after the release</li>

</ul>

</section>
</section>
<section>
<section id="slide-org3989539">
<h3 id="org3989539"><code>curl</code></h3>
<ul>
<li>new version did not compile on Solaris</li>

</ul>
<img class="stretch" src="img/curl-release.png">
<ul>
<li>issue was fixed after the release</li>
<li>until new releases come out we have to live with patches</li>

</ul>

</section>
</section>
<section>
<section id="slide-org3493bf8">
<h2 id="org3493bf8">how the community helps</h2>
<ul>
<li>had to harden our compiled libraries and binaries
<ul>
<li>easy: check how Debian or CentOS build our packages</li>

</ul></li>
<li>puppet release 6.11.0 had a regression
<ul>
<li>community provided a fix shortly after we released</li>

</ul></li>

</ul>

</section>
</section>
<section>
<section id="slide-orgcae850e">
<h2 id="orgcae850e">how we contribute back</h2>
<ul>
<li>we use <code>ruby</code> extensively on non-standard platforms</li>
<li>sometimes we discover issues</li>

</ul>

</section>
</section>
<section>
<section id="slide-org953a580">
<h3 id="org953a580">segfaulting with <code>facter</code></h3>
<div class="org-src-container">

<pre  class="src src-ruby"><span style="font-weight: bold; text-decoration: underline;">Facter</span>.add(<span style="font-style: italic;">'test'</span>) <span style="font-weight: bold;">do</span>
  url = <span style="font-style: italic;">'https://api.ipify.org?format=json'</span>
  <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">{"ip":"79.114.90.219"}</span>
  response = <span style="font-weight: bold;">open</span>(url).read
  <span style="font-weight: bold;">if</span> !response.to_s.empty?
    result = <span style="font-weight: bold; text-decoration: underline;">JSON</span>.parse(response)
    setcode { result[<span style="font-style: italic;">'ip'</span>] }
  <span style="font-weight: bold;">end</span>
<span style="font-weight: bold;">end</span>
</pre>
</div>
<ul>
<li>custom fact that queries an API for your public IP</li>

</ul>
<pre class="example">
$ facter test
79.114.90.219
</pre>

</section>
<section id="slide-orgfedf4f4">
<h4 id="orgfedf4f4">on windows though&#x2026;</h4>
<div style="font-size: 0.7em;">
<pre  class="example">
C:/Program Files/Puppet Labs/Puppet/puppet/lib/ruby/2.5.0/net/protocol.rb:45: [BUG] Segmentation fault
ruby 2.5.3p105 (2018-10-18 revision 65156) [x64-mingw32]

-- Control frame information -----------------------------------------------
c:0024 p:---- s:0165 e:000164 CFUNC  :wait_readable
c:0023 p:0093 s:0160 e:000159 METHOD C:/Program Files/Puppet Labs/Puppet/puppet/lib/ruby/2.5.0/net/protocol.rb:45
c:0022 p:0557 s:0153 E:001568 METHOD C:/Program Files/Puppet Labs/Puppet/puppet/lib/ruby/2.5.0/net/http.rb:981
c:0021 p:0004 s:0140 e:000139 METHOD C:/Program Files/Puppet Labs/Puppet/puppet/lib/ruby/2.5.0/net/http.rb:920
c:0020 p:0029 s:0136 e:000135 METHOD C:/Program Files/Puppet Labs/Puppet/puppet/lib/ruby/2.5.0/net/http.rb:909
c:0019 p:0521 s:0132 e:000131 METHOD C:/Program Files/Puppet Labs/Puppet/puppet/lib/ruby/2.5.0/open-uri.rb:337
c:0018 p:0017 s:0111 e:000110 METHOD C:/Program Files/Puppet Labs/Puppet/puppet/lib/ruby/2.5.0/open-uri.rb:755
c:0017 p:0029 s:0104 e:000103 BLOCK  C:/Program Files/Puppet Labs/Puppet/puppet/lib/ruby/2.5.0/open-uri.rb:226 [FINISH]
c:0016 p:---- s:0101 e:000100 CFUNC  :catch
c:0015 p:0365 s:0096 E:0010e8 METHOD C:/Program Files/Puppet Labs/Puppet/puppet/lib/ruby/2.5.0/open-uri.rb:224
c:0014 p:0328 s:0081 e:000080 METHOD C:/Program Files/Puppet Labs/Puppet/puppet/lib/ruby/2.5.0/open-uri.rb:165
c:0013 p:0018 s:0069 e:000068 METHOD C:/Program Files/Puppet Labs/Puppet/puppet/lib/ruby/2.5.0/open-uri.rb:735
c:0012 p:0071 s:0063 e:000062 METHOD C:/Program Files/Puppet Labs/Puppet/puppet/lib/ruby/2.5.0/open-uri.rb:35
c:0011 p:0007 s:0055 e:000054 BLOCK  C:/cygwin64/home/Administrator/facts/ip.rb:10
c:0010 p:0030 s:0052 E:000948 BLOCK  C:/Program Files/Puppet Labs/Puppet/puppet/lib/ruby/2.5.0/timeout.rb:93
c:0009 p:0005 s:0046 e:000045 BLOCK  C:/Program Files/Puppet Labs/Puppet/puppet/lib/ruby/2.5.0/timeout.rb:33 [FINISH]
c:0008 p:---- s:0043 e:000042 CFUNC  :catch
c:0007 p:0044 s:0038 e:000037 METHOD C:/Program Files/Puppet Labs/Puppet/puppet/lib/ruby/2.5.0/timeout.rb:33
c:0006 p:0113 s:0032 E:000650 METHOD C:/Program Files/Puppet Labs/Puppet/puppet/lib/ruby/2.5.0/timeout.rb:108
c:0005 p:0021 s:0020 E:000748 BLOCK  C:/cygwin64/home/Administrator/facts/ip.rb:9 [FINISH]
c:0004 p:---- s:0014 e:000013 CFUNC  :instance_eval
c:0003 p:---- s:0011 e:000010 CFUNC  :add
c:0002 p:0034 s:0006 E:000790 TOP    C:/cygwin64/home/Administrator/facts/ip.rb:5 [FINISH]
c:0001 p:0000 s:0003 E:000640 (none) [FINISH]
</pre>
</div>

</section>
<section id="slide-orgd358590">
<h4 id="orgd358590">the elephant in the room</h4>
<ul>
<li>this code is not directly evaluated by the Ruby interpreter</li>
<li>the <code>Facter.add</code> implementation looks like this:</li>

</ul>
<div class="org-src-container">

<pre  class="src src-C++"><span style="font-weight: bold; text-decoration: underline;">VALUE</span> <span style="font-weight: bold; text-decoration: underline;">module</span>::<span style="font-weight: bold;">ruby_add</span>(<span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">argc</span>, <span style="font-weight: bold; text-decoration: underline;">VALUE</span>* <span style="font-weight: bold; font-style: italic;">argv</span>, <span style="font-weight: bold; text-decoration: underline;">VALUE</span> <span style="font-weight: bold; font-style: italic;">self</span>)
{
    <span style="font-weight: bold;">return</span> safe_eval(<span style="font-style: italic;">"Facter.add"</span>, [&amp;]() {
        <span style="font-weight: bold;">auto</span> <span style="font-weight: bold;">const</span>&amp; <span style="font-weight: bold; font-style: italic;">ruby</span> = <span style="font-weight: bold; text-decoration: underline;">api</span>::instance();

        <span style="font-weight: bold; text-decoration: underline;">VALUE</span> <span style="font-weight: bold; font-style: italic;">fact_self</span> = from_self(self)-&gt;create_fact(argv[0]);

        ...

        <span style="font-weight: bold;">return</span> fact_self;
    });
}
</pre>
</div>

</section>
<section id="slide-org1298ed1">
<h4 id="org1298ed1">what we knew</h4>
<ul>
<li>this worked on ruby 2.4 but crashed on 2.5</li>
<li>only happened on Windows</li>
<li>somehow linked to the URL opening part</li>

</ul>

</section>
<section id="slide-org0e6a38e">
<h4 id="org0e6a38e">next steps</h4>
<ul>
<li>check what changed in <code>ruby</code> between 2.4 and 2.5</li>

</ul>
<pre class="example">
$ git diff --stat v2_4_5..v2_5_3
...
6101 files changed, 340476 insertions(+), 79434 deletions(-)
</pre>

<ul>
<li>thousands of commits, hundreds of thousands of lines</li>
<li>only 60 commits on the windows tree</li>

</ul>
<pre class="example">
git rev-list --count v2_4_5..v2_5_3 -- win32/
60
</pre>

</section>
<section id="slide-orgd956653">
<h4 id="orgd956653">what we could have done</h4>
<ul>
<li>use <code>git-bisect(1)</code> to find the culprit</li>
<li class="fragment appear"><p>
programatically determine which commit is responsible by building the project and testing the problematic fact
</p>
<img src="img/drake-no.jpg" width="50%"></li>

</ul>

</section>
<section id="slide-org3f5559f">
<h4 id="org3f5559f">what we did</h4>
<ul>
<li>figure it out by manually going through each commit</li>

</ul>
<img src="img/drake-yes.jpg" width="50%">

</section>
<section id="slide-orga0f7b90">
<h4 id="orga0f7b90">windows sockets?</h4>
<ul>
<li>a chunk of commit <code>e33b169 - win32.c: vm_exit_handler</code></li>

</ul>
<img class="stretch" src="img/ruby-define.png">
<ul>
<li>this replaces all references of <code>NtSocketsInitialized</code> with <code>1</code> before compile time</li>

</ul>

</section>
<section id="slide-org79e2751">
<h4 id="org79e2751"><code>NtSocketsInitialized</code></h4>
<ul>
<li>this variable is referenced over 30 times in the file, similar to the code below:</li>

</ul>
<div class="org-src-container">

<pre  class="src src-C"><span style="font-weight: bold;">if</span> (!NtSocketsInitialized) {
    StartSockets();
}
</pre>
</div>
<ul>
<li class="fragment appear"><p>
after preprocessing, the bit becomes:
</p>
<pre class="example">
[~/repo/ruby]$ cpp win32/win32.c
</pre>

<div class="org-src-container">

<pre  class="src src-C"><span style="font-weight: bold;">if</span> (!1) {
    StartSockets();
}
</pre>
</div></li>
<li class="fragment appear"><code>StartSockets()</code> is the function responsible to initialize the Winsock DLL</li>
<li class="fragment appear">Winsock handles internet I/O requests for Windows</li>
<li class="fragment appear">There&rsquo;s no networking without Winsock</li>

</ul>

</section>
<section id="slide-org0579bd7">
<h4 id="org0579bd7">getting to the point</h4>
<ul class="fragment appear">
<li>after commit <a href="https://github.com/ruby/ruby/commit/e33b1690d06f867e45750bd8e3e8b06d78b5bc26"><code>e33b169</code></a>, <code>StartSockets()</code> goes from possibly being called in 34 places</li>
<li><p>
to getting called <b>once</b>
</p>

<div class="org-src-container">

<pre  class="src src-C"><span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">rb_w32_sysinit</span>(<span style="font-weight: bold; text-decoration: underline;">int</span> *<span style="font-weight: bold; font-style: italic;">argc</span>, <span style="font-weight: bold; text-decoration: underline;">char</span> ***<span style="font-weight: bold; font-style: italic;">argv</span>)
{
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">...</span>
    tzset();
    init_env();
    init_stdhandle();
    atexit(exit_handler);

    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">Initialize Winsock</span>
    StartSockets();
}
</pre>
</div></li>

</ul>

</section>
<section id="slide-org1d9dbd4">
<h4 id="org1d9dbd4"></h4>
<ul>
<li><code>rb_w32_sysinit</code> is a function that we have to call manually if we&rsquo;re embedding the Ruby interpreter</li>
<li>to be platform-agnostic we can call the main <code>sysinit</code> function:</li>

</ul>
<div class="org-src-container">

<pre  class="src src-C"><span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">ruby_sysinit</span>(<span style="font-weight: bold; text-decoration: underline;">int</span> *<span style="font-weight: bold; font-style: italic;">argc</span>, <span style="font-weight: bold; text-decoration: underline;">char</span> ***<span style="font-weight: bold; font-style: italic;">argv</span>)
{
<span style="font-weight: bold;">#if</span> <span style="font-weight: bold;">defined</span>(_WIN32)
    rb_w32_sysinit(argc, argv);
<span style="font-weight: bold;">#endif</span>
...
}
</pre>
</div>

</section>
<section id="slide-orgbb07f86">
<h4 id="orgbb07f86">fixing stuff</h4>
<ul>
<li>we try calling the function in a simple C program</li>

</ul>
<div class="org-src-container">

<pre  class="src src-C"><span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">ruby_sysinit</span>(<span style="font-weight: bold; text-decoration: underline;">int</span> *<span style="font-weight: bold; font-style: italic;">argc</span>, <span style="font-weight: bold; text-decoration: underline;">char</span> ***<span style="font-weight: bold; font-style: italic;">argv</span>)
{
<span style="font-weight: bold;">#if</span> <span style="font-weight: bold;">defined</span>(_WIN32)
    rb_w32_sysinit(argc, argv);
<span style="font-weight: bold;">#endif</span>
...
}
</pre>
</div>
<div class="org-src-container">

<pre  class="src src-C"><span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">ruby_sysinit</span>(<span style="font-weight: bold; text-decoration: underline;">int</span> *<span style="font-weight: bold; font-style: italic;">argc</span>, <span style="font-weight: bold; text-decoration: underline;">char</span> ***<span style="font-weight: bold; font-style: italic;">argv</span>)
{
<span style="font-weight: bold;">#if</span> <span style="font-weight: bold;">defined</span>(_WIN32)
    rb_w32_sysinit(argc, argv);
<span style="font-weight: bold;">#endif</span>
...
}
</pre>
</div>

<div class="org-src-container">

<pre  class="src src-C"><span style="font-weight: bold; text-decoration: underline;">void</span> <span style="font-weight: bold;">ruby_sysinit</span>(<span style="font-weight: bold; text-decoration: underline;">int</span> *<span style="font-weight: bold; font-style: italic;">argc</span>, <span style="font-weight: bold; text-decoration: underline;">char</span> ***<span style="font-weight: bold; font-style: italic;">argv</span>)
{
    <span style="font-weight: bold; text-decoration: underline;">int</span> <span style="font-weight: bold; font-style: italic;">state</span>;
    <span style="font-weight: bold; text-decoration: underline;">VALUE</span> <span style="font-weight: bold; font-style: italic;">result</span>;
}
</pre>
</div>
</section>
</section>
</div>
</div>
<script src="./reveal.js/lib/js/head.min.js"></script>
<script src="./reveal.js/js/reveal.js"></script>
<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: true,
progress: true,
history: false,
center: true,
slideNumber: 'c',
rollingLinks: false,
keyboard: true,
mouseWheel: false,
fragmentInURL: false,
pdfSeparateFragments: true,

overview: true,
width: 1200,
height: 800,

theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
transition: Reveal.getQueryHash().transition || 'slide', // default/cube/page/concave/zoom/linear/fade/none
transitionSpeed: 'default',
multiplex: {
    secret: '', // null if client
    id: '', // id, obtained from socket.io server
    url: '' // Location of socket.io server
},

// Optional libraries used to extend on reveal.js
dependencies: [
 { src: './reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }]
});
</script>
</body>
</html>
