<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Open Source at Puppet</title>
<meta name="author" content="Gabriel Nagy"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="./reveal.js/css/reveal.css"/>

<link rel="stylesheet" href="./reveal.js/css/theme/blood.css" id="theme"/>

<link rel="stylesheet" href="./data/index.css"/>
<link rel="stylesheet" href="data/an-old-hope.css"/>

<!-- If the query includes 'print-pdf', include the PDF print sheet -->
<script>
    if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = './reveal.js/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    }
</script>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide">
<h2>Open Source at Puppet</h2>Gabriel Nagy
</section>

<section>
<section id="slide-org5221497">
<h2 id="org5221497"><code>$ whoami</code></h2>
<ul>
<li>Linux &amp; FOSS user</li>
<li>at Puppet since May</li>
<li>working on awesome open-source projects</li>

</ul>

</section>
</section>
<section>
<section id="slide-orgc788a5e">
<h2 id="orgc788a5e">what is this?</h2>
<ul>
<li>overview of our projects</li>
<li>how we benefit from using, and being open source ourselves</li>
<li>why is open-source beneficial</li>

</ul>

</section>
</section>
<section>
<section id="slide-org5ea6563">
<h2 id="org5ea6563">puppet-agent</h2>
<ul>
<li>collection of software required for <code>puppet</code> and its dependencies to run</li>
<li>bundles the following:
<ul>
<li><code>runtime</code> - we build our own <code>ruby</code>, <code>curl</code>, <code>openssl</code>, <code>boost</code>, etc.</li>
<li><code>puppet</code> - Ruby gem, our main project</li>
<li><code>facter</code> - Ruby gem (v2), and C++ binary and libraries (v3)</li>
<li><code>...</code> - a bunch of other dependencies (Ruby, C++)</li>

</ul></li>
<li>built, tested, and shipped for <b>45 OSes/platforms</b> (as of November)</li>

</ul>

</section>
</section>
<section>
<section id="slide-orga85bcb3">
<h3 id="orga85bcb3"><code>puppet</code></h3>
<ul>
<li>configuration management tool, declarative language</li>

</ul>

<pre class="example">
$ puppet resource user gabi
</pre>

<div class="org-src-container">

<pre><code class=" puppet" >user { 'gabi':
  ensure  =&gt; 'present',
  comment =&gt; 'gabi',
  gid     =&gt; 1000,
  groups  =&gt; ['wheel', 'input', 'lp', 'sys', 'network', 'docker'],
  home    =&gt; '/home/gabi',
  shell   =&gt; '/bin/zsh',
  uid     =&gt; 1000,
}
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-org5a36865">
<h3 id="org5a36865"><code>facter</code></h3>
<ul>
<li>provides facts about the system (network, disks, memory, OS)</li>
<li>current version in C++, can be extended with custom Ruby facts</li>
<li>can be used through a shared library, or standalone by calling its executable</li>

</ul>

<pre class="example">
$ facter system_uptime --json
</pre>

<div class="org-src-container">

<pre><code class=" js" >{
  "system_uptime": {
    "days": 0,
    "hours": 1,
    "seconds": 4322,
    "uptime": "1:12 hours"
  }
}
</code></pre>
</div>

</section>
</section>
<section>
<section id="slide-org761b01c">
<h2 id="org761b01c">how we use open source</h2>
<ul>
<li class="fragment appear">keep our runtime up-to-date by patching CVEs</li>
<li class="fragment appear">October vulnerabilities:
<ul>
<li>Ruby</li>
<li>OpenSSL</li>
<li>cURL</li>

</ul></li>
<li class="fragment appear">all upgrades were problematic</li>

</ul>

</section>
</section>
<section>
<section id="slide-org0a4c6f9">
<h3 id="org0a4c6f9"><code>ruby</code></h3>
<ul>
<li>hotfix release did not install</li>
<li>the version we had to upgrade to was 2.4.8</li>

</ul>
<img class="stretch" src="img/ruby-release.png">
<ul>
<li>2.4.9 was released a couple of minutes before we checked <a href="https://www.ruby-lang.org/">ruby-lang.org</a></li>

</ul>

</section>
</section>
<section>
<section id="slide-org29507b6">
<h3 id="org29507b6"><code>openssl</code></h3>
<ul>
<li>new version did not compile on Windows</li>

</ul>
<img class="stretch" src="img/openssl-release.png">
<ul>
<li>the openssl release prep commit itself did not pass CI</li>
<li>issue was fixed after the release</li>

</ul>

</section>
</section>
<section>
<section id="slide-orgd155ce2">
<h3 id="orgd155ce2"><code>curl</code></h3>
<ul>
<li>new version did not compile on Solaris</li>

</ul>
<img class="stretch" src="img/curl-release.png">
<ul>
<li>issue was fixed after the release</li>
<li>until new releases come out we have to live with patches</li>

</ul>

</section>
</section>
<section>
<section id="slide-orgfbfde0e">
<h3 id="orgfbfde0e">conclusions?</h3>
<ul>
<li>open-source projects are widely used and understaffed
<ul>
<li><code>curl</code> has been maintained for over 20 years by a single person</li>
<li><code>openssl</code> had 2 developers before the Heartbleed vulnerability</li>
<li><code>ruby</code> - around 20 people are actively contributing</li>

</ul></li>
<li>most of the time projects are maintained through volunteer efforts</li>

</ul>

</section>
</section>
<section>
<section id="slide-org7a79a4f">
<h2 id="org7a79a4f">how the community helps</h2>
<ul>
<li>had to update our compile/link flags for our vendored libraries and binaries
<ul>
<li>easy: check how Debian/CentOS/Arch build our packages</li>

</ul></li>
<li>our latest <code>puppet</code> release had a regression
<ul>
<li>community provided a fix shortly after we released</li>

</ul></li>

</ul>

</section>
</section>
<section>
<section id="slide-org50dc7fb">
<h2 id="org50dc7fb">how we contribute back</h2>
<ul>
<li>we use <code>ruby</code> extensively on non-standard platforms</li>
<li>sometimes we discover issues</li>

</ul>

</section>
</section>
<section>
<section id="slide-org0da29d0">
<h3 id="org0da29d0">segfaulting with <code>facter</code></h3>
<div class="org-src-container">

<pre><code class=" ruby" >Facter.add('ip') do
  url = 'https://api.ipify.org?format=json'
  # {"ip":"79.114.90.219"}
  response = open(url).read
  if !response.to_s.empty?
    result = JSON.parse(response)
    setcode { result['ip'] }
  end
end
</code></pre>
</div>
<ul>
<li>custom fact that queries an API for your public IP</li>

</ul>
<pre class="example">
$ facter ip
79.114.90.219
</pre>

</section>
<section id="slide-orgae000a8">
<h4 id="orgae000a8">on windows though&#x2026;</h4>
<pre class="example">
$ facter ip
</pre>

<div style="font-size: 0.78em;">
<pre  class="example">
C:/Program Files/Puppet Labs/Puppet/puppet/lib/ruby/2.5.0/net/protocol.rb:45: [BUG] Segmentation fault
ruby 2.5.3p105 (2018-10-18 revision 65156) [x64-mingw32]

-- Control frame information -----------------------------------------------
c:0024 p:---- s:0165 e:000164 CFUNC  :wait_readable
c:0023 p:0093 s:0160 e:000159 METHOD C:/puppet/lib/ruby/2.5.0/net/protocol.rb:45
c:0022 p:0557 s:0153 E:001568 METHOD C:/puppet/lib/ruby/2.5.0/net/http.rb:981
c:0021 p:0004 s:0140 e:000139 METHOD C:/puppet/lib/ruby/2.5.0/net/http.rb:920
c:0020 p:0029 s:0136 e:000135 METHOD C:/puppet/lib/ruby/2.5.0/net/http.rb:909
c:0019 p:0521 s:0132 e:000131 METHOD C:/puppet/lib/ruby/2.5.0/open-uri.rb:337
c:0018 p:0017 s:0111 e:000110 METHOD C:/puppet/lib/ruby/2.5.0/open-uri.rb:755
c:0017 p:0029 s:0104 e:000103 BLOCK  C:/puppet/lib/ruby/2.5.0/open-uri.rb:226 [FINISH]
c:0016 p:---- s:0101 e:000100 CFUNC  :catch
c:0015 p:0365 s:0096 E:0010e8 METHOD C:/puppet/lib/ruby/2.5.0/open-uri.rb:224
c:0014 p:0328 s:0081 e:000080 METHOD C:/puppet/lib/ruby/2.5.0/open-uri.rb:165
c:0013 p:0018 s:0069 e:000068 METHOD C:/puppet/lib/ruby/2.5.0/open-uri.rb:735
c:0012 p:0071 s:0063 e:000062 METHOD C:/puppet/lib/ruby/2.5.0/open-uri.rb:35
c:0011 p:0007 s:0055 e:000054 BLOCK  C:/cygwin64/home/Administrator/facts/ip.rb:10
c:0010 p:0030 s:0052 E:000948 BLOCK  C:/puppet/lib/ruby/2.5.0/timeout.rb:93
c:0009 p:0005 s:0046 e:000045 BLOCK  C:/puppet/lib/ruby/2.5.0/timeout.rb:33 [FINISH]
c:0008 p:---- s:0043 e:000042 CFUNC  :catch
c:0007 p:0044 s:0038 e:000037 METHOD C:/puppet/lib/ruby/2.5.0/timeout.rb:33
c:0006 p:0113 s:0032 E:000650 METHOD C:/puppet/lib/ruby/2.5.0/timeout.rb:108
c:0005 p:0021 s:0020 E:000748 BLOCK  C:/cygwin64/home/Administrator/facts/ip.rb:9 [FINISH]
c:0004 p:---- s:0014 e:000013 CFUNC  :instance_eval
c:0003 p:---- s:0011 e:000010 CFUNC  :add
c:0002 p:0034 s:0006 E:000790 TOP    C:/cygwin64/home/Administrator/facts/ip.rb:5 [FINISH]
c:0001 p:0000 s:0003 E:000640 (none) [FINISH]
</pre>
</div>

</section>
<section id="slide-org657539d">
<h4 id="org657539d">the elephant in the room</h4>
<ul>
<li>this code is not directly evaluated by the Ruby interpreter</li>
<li>the <code>Facter.add</code> implementation looks like this:</li>

</ul>
<div class="org-src-container">

<pre><code class=" C++" >VALUE module::ruby_add(int argc, VALUE* argv, VALUE self)
{
    return safe_eval("Facter.add", [&amp;]() {
	auto const&amp; ruby = api::instance();

	VALUE fact_self = from_self(self)-&gt;create_fact(argv[0]);

	...

	return fact_self;
    });
}
</code></pre>
</div>

</section>
<section id="slide-org5237bcc">
<h4 id="org5237bcc">what we knew</h4>
<ul>
<li>this worked on ruby 2.4 but crashed on 2.5</li>
<li>only happened on Windows</li>
<li>somehow linked to the URL opening part</li>

</ul>

</section>
<section id="slide-org297e1b0">
<h4 id="org297e1b0">next steps</h4>
<ul>
<li>check what changed in <code>ruby</code> between 2.4 and 2.5</li>

</ul>
<pre class="example">
$ git diff --stat v2_4_5..v2_5_3
...
6101 files changed, 340476 insertions(+), 79434 deletions(-)
</pre>

<ul class="fragment appear">
<li>only 60 commits under <code>win32/</code></li>

</ul>
<pre  class="fragment appear">
$ git rev-list --count v2_4_5..v2_5_3 -- win32/
60
</pre>

</section>
<section id="slide-orgbbc243b">
<h4 id="orgbbc243b">what we could have done</h4>
<img class="stretch" src="img/drake-no.jpg">

</section>
<section id="slide-orgb068515">
<h4 id="orgb068515">what we could have done</h4>
<img class="stretch" src="img/drake-no-1.jpg">

</section>
<section id="slide-org0a82e9b">
<h4 id="org0a82e9b">what we did</h4>
<img class="stretch" src="img/drake-yes.jpg">

</section>
<section id="slide-orga9788e8">
<h4 id="orga9788e8">what we did</h4>
<img class="stretch" src="img/drake-yes-1.jpg">

</section>
<section id="slide-org6e16c07">
<h4 id="org6e16c07">windows sockets?</h4>
<ul>
<li>a chunk of commit <code>e33b169 - win32.c: vm_exit_handler</code></li>

</ul>
<img class="stretch" src="img/ruby-define.png">
<ul>
<li>this replaces all references of <code>NtSocketsInitialized</code> with <code>1</code> before compile time</li>

</ul>

</section>
<section id="slide-org64d3b7b">
<h4 id="org64d3b7b"><code>NtSocketsInitialized</code></h4>
<ul>
<li>this variable is referenced over 30 times in the file, similar to the code below:</li>

</ul>
<div class="org-src-container">

<pre><code class=" C" >if (!NtSocketsInitialized) {
    StartSockets();
}
</code></pre>
</div>
<ul>
<li class="fragment appear"><p>
after preprocessing, the bit becomes:
</p>
<pre class="example">
[~/repo/ruby]$ cpp win32/win32.c
</pre>

<div class="org-src-container">

<pre><code class=" C" >if (!1) {
    StartSockets();
}
</code></pre>
</div></li>
<li class="fragment appear"><code>StartSockets()</code> is the function responsible to initialize the Winsock DLL</li>
<li class="fragment appear">Winsock handles internet I/O requests for Windows</li>
<li class="fragment appear">There&rsquo;s no networking without Winsock</li>

</ul>

</section>
<section id="slide-org754fb2e">
<h4 id="org754fb2e">getting to the point</h4>
<ul class="fragment appear">
<li>after commit <a href="https://github.com/ruby/ruby/commit/e33b1690d06f867e45750bd8e3e8b06d78b5bc26"><code>e33b169</code></a>, <code>StartSockets()</code> goes from possibly being called in 34 places</li>
<li><p>
to getting called <b>once</b>
</p>

<div class="org-src-container">

<pre><code class=" C" >void rb_w32_sysinit(int *argc, char ***argv)
{
    // ...
    tzset();
    init_env();
    init_stdhandle();
    atexit(exit_handler);

    // Initialize Winsock
    StartSockets();
}
</code></pre>
</div></li>

</ul>

</section>
<section id="slide-org773b042">
<h4 id="org773b042"></h4>
<ul>
<li><code>rb_w32_sysinit</code> is a function that we have to call manually if we&rsquo;re embedding the Ruby interpreter</li>
<li>to be platform-agnostic we can call the main <code>sysinit</code> function:</li>

</ul>
<div class="org-src-container">

<pre><code class=" C" >void ruby_sysinit(int *argc, char ***argv)
{
#if defined(_WIN32)
    rb_w32_sysinit(argc, argv);
#endif
...
}
</code></pre>
</div>

</section>
<section id="slide-org9fc86d3" class="no-center">
<h4 id="org9fc86d3">fixing stuff</h4>
<ul>
<li>before calling <code>ruby_sysinit</code></li>

</ul>
<div class="org-src-container">

<pre><code class=" C" >#include &lt;ruby.h&gt;

int main()
{
    ruby_init(); // sets up some basic things
    char* options[] = { "-v", "-e", "" };
    ruby_options(3, options); // sets up more stuff

    rb_require("open-uri");
    rb_eval_string("puts open('http://api.ipify.org?format=json').read");
}
</code></pre>
</div>
<pre  class="fragment appear">
C:/tools/ruby26/lib/ruby/2.6.0/net/http.rb:949:in `rescue in block in connect':
Failed to open TCP connection to api.ipify.org:80 (getaddrinfo: Either the application has not called WSAStartup, or WSAStartup failed.) (SocketError)
</pre>

</section>
<section id="slide-org83a0925" class="no-center">
<h4 id="org83a0925">fixing stuff</h4>
<ul>
<li>after calling <code>ruby_sysinit</code></li>

</ul>
<div class="org-src-container">

<pre><code class=" C" >#include &lt;ruby.h&gt;

int main()
{
    ruby_init(); // sets up some basic things
    char* options[] = { "-v", "-e", "" };
    ruby_options(3, options); // sets up more stuff

    int sysinit_opts_size = 1;
    char const* sysinit_opts[] = { "ruby" };
    ruby_sysinit(&amp;sysinit_opts_size, (char***)(&amp;sysinit_opts));

    rb_require("open-uri");
    rb_eval_string("puts open('http://api.ipify.org?format=json').read");
}
</code></pre>
</div>

<pre  class="fragment appear">
{"ip":"192.69.65.12"}
</pre>
</section>
<section id="slide-org5579bf7" data-background="#006400">
<h4 id="org5579bf7">finishing up</h4>
<ul>
<li>opened a pull request on GitHub for <code>ruby/ruby</code></li>

</ul>
<img class="stretch" src="img/ruby-github-open.png">

</section>
<section id="slide-org8ea09cf" data-background="#483D8B">
<h4 id="org8ea09cf">finishing up</h4>
<ul>
<li>merged after almost 2 months</li>

</ul>
<img class="stretch" src="img/ruby-github-merged.png">

</section>
<section id="slide-org5b8c9dc">
<h4 id="org5b8c9dc">conclusions</h4>
<ul>
<li>Ruby API documentation is not up-to-date, especially for less-used platforms</li>
<li>the best way to understand things is to go through the code</li>

</ul>
</section>
</section>
</div>
</div>
<script src="./reveal.js/lib/js/head.min.js"></script>
<script src="./reveal.js/js/reveal.js"></script>
<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: true,
progress: true,
history: true,
center: true,
slideNumber: 'c',
rollingLinks: false,
keyboard: true,
mouseWheel: true,
fragmentInURL: false,
hashOneBasedIndex: false,
pdfSeparateFragments: true,

overview: true,
width: 1200,
height: 800,

theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
transition: Reveal.getQueryHash().transition || 'fade', // see README of reveal.js for options
transitionSpeed: 'default',

// Optional libraries used to extend reveal.js
dependencies: [
 { src: './reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
 { src: './reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }]

});
</script>
</body>
</html>
